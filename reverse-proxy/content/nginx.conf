# Copyright (c) Microsoft. All rights reserved.

# TODO: add SSL and remove port 80
# TODO: verify whether the resolver/DNS works (or has no impact) when running with Kubernetes
# TODO: remove logs or move outside of the container

daemon                off;
worker_processes      1;
error_log             /app/logs/error.log;
pid                   /app/logs/nginx.pid;
worker_rlimit_nofile  131072;

events {
    worker_connections 1024;
}

http {
    # Required so that nginx can resolve IPs when working with Docker Compose
    resolver 127.0.0.11 ipv6=off;

    include /etc/nginx/mime.types;
    default_type text/plain;

    index    index.html index.htm;

    log_format upstreaminfo '$remote_addr - '
        '[$proxy_add_x_forwarded_for] - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" '
        '$request_length $request_time $upstream_addr $upstream_response_length $upstream_response_time $upstream_status';

    access_log /app/logs/access.log  upstreaminfo;
    error_log  /app/logs/error.log;

    server {
        listen              80;
        listen              443 ssl;
        ssl                 on;
        server_name         reverseproxy 127.0.0.1;
        ssl_certificate     /app/certs/tls.crt;
        ssl_certificate_key /app/certs/tls.key;

        add_header Cache-Control "no-cache";
        expires 0;

        set $webui_endpoint       "http://webui:80";
        set $auth_endpoint        "http://auth:9001";
        set $iothub_endpoint      "http://iothubmanager:9002";
        set $simulation_endpoint  "http://devicesimulation:9003";
        set $telemetry_endpoint   "http://telemetry:9004";
        set $config_endpoint      "http://uiconfig:9005";

        location / {
            proxy_pass           $webui_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }

        location /auth/ {
            rewrite              /auth/(.*) /$1 break;
            proxy_pass           $auth_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }

        location /iothub/ {
            rewrite              /iothub/(.*) /$1 break;
            proxy_pass           $iothub_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }

        location /simulation/ {
            rewrite              /simulation/(.*) /$1 break;
            proxy_pass           $simulation_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }

        location /telemetry/ {
            rewrite              /telemetry/(.*) /$1 break;
            proxy_pass           $telemetry_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }

        location /config/ {
            rewrite              /config/(.*) /$1 break;
            proxy_pass           $config_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }

        # TODO: drop this when all clients have moved to /iothub/
        location /iothubmanager/ {
            rewrite              /iothubmanager/(.*) /$1 break;
            proxy_pass           $iothub_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }

        # TODO: drop this when all clients have moved to /telemetry/
        location /devicetelemetry/ {
            rewrite              /devicetelemetry/(.*) /$1 break;
            proxy_pass           $telemetry_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }

        # TODO: drop this when all clients have moved to /simulation/
        location /devicesimulation/ {
            rewrite              /devicesimulation/(.*) /$1 break;
            proxy_pass           $simulation_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }

        # TODO: drop this when all clients have moved to /config/
        location /uiconfig/ {
            rewrite              /uiconfig/(.*) /$1 break;
            proxy_pass           $config_endpoint;
            proxy_pass_header    Authorization;
            # TODO ~devis: remove - https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/issues/11
            # Public preview only: used to distinguish internal/external traffic
            proxy_set_header     X-Source external;
            proxy_buffering      off;
            client_max_body_size 0;
            proxy_read_timeout   3600s;
            proxy_redirect       off;
        }
    }
}
